<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íšŒì›ê°€ì… | í•œì„±ëŒ€ í•™ìˆ ì •ë³´ê´€</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #e0f2ff;
      margin: 0;
      text-align: center;
    }
    .container {
      max-width: 420px;
      margin: auto;
      padding: 40px 20px;
      background-color: #e0f2ff;
      min-height: 100vh;
    }
    h2 {
      color: #1976d2;
      font-size: 1.8em;
      margin-bottom: 30px;
    }
    input, button {
      padding: 12px;
      margin: 10px 0;
      font-size: 1em;
      border: none;
      border-radius: 30px;
      width: 80%;
      box-sizing: border-box;
    }
    input {
      border: 1px solid #ccc;
    }
    button {
      background-color: #1976d2;
      color: white;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
    }
    button:hover {
      background-color: #145ea8;
    }
    .message {
      color: #2e7d32;
      font-weight: bold;
      margin-top: 10px;
      font-size: 1.05em;
    }
    .error {
      color: #d32f2f;
    }
    #face-section {
      margin-top: 20px;
      padding: 20px;
      background-color: #d0eaff;
      border-radius: 16px;
      border: 2px dashed #1976d2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>í•™ìˆ ì •ë³´ê´€ íšŒì›ê°€ì…</h2>

    {% if face_success %}
    <p class="message">âœ… ì–¼êµ´ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
    {% endif %}

    {% if message %}
    <p class="message {{ 'error' if 'ì‹¤íŒ¨' in message else '' }}">{{ message }}</p>
    {% endif %}

    <form method="POST" action="/register">
      <input type="text" name="student_id" placeholder="í•™ë²ˆ" value="{{ student_id or '' }}" required><br>
      <input type="text" name="name" placeholder="ì´ë¦„" value="{{ name or '' }}" required><br>
      <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="{{ password or '' }}" required><br>
      <button type="submit">íšŒì›ê°€ì… ì™„ë£Œ</button>
    </form>

    <div id="face-section">
      <p style="font-size: 0.95em; color: #555;">
        ğŸ˜„ <strong>ì„ íƒ ì‚¬í•­</strong>ì…ë‹ˆë‹¤.<br>
        ì–¼êµ´ ì¸ì‹ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë“±ë¡í•´ ì£¼ì„¸ìš”.
      </p>
      <p style="font-size: 0.85em; color: #777; margin-top: -5px;">
        ğŸ“Œ ë“±ë¡ ë°©ë²•:<br>
        1. 'ì–¼êµ´ ë“±ë¡í•˜ê¸°'ë¥¼ ëˆ„ë¥´ë©´ ì¹´ë©”ë¼ê°€ ì¼œì§‘ë‹ˆë‹¤.<br>
        2. ì •ë©´ì„ ë°”ë¼ë´ ì£¼ì„¸ìš”.<br>
        3. 'ì–¼êµ´ ë“±ë¡' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.<br>
        4. ì´í›„ íšŒì›ì •ë³´ ì…ë ¥ í›„ [íšŒì›ê°€ì… ì™„ë£Œ]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </p>

      <button onclick="showFaceRegister()">ğŸ“¸ ì–¼êµ´ ë“±ë¡í•˜ê¸°</button>

      <div id="face-register-ui" style="display: none; margin-top: 20px;">
        <img id="face-cam" src="" width="320" height="240" style="border-radius: 12px; border: 1px solid #1976d2;"><br><br>

        <input type="hidden" id="student_id_ajax" value="">
        <button type="button" onclick="saveFace()">ì–¼êµ´ ë“±ë¡</button>
        <button type="button" onclick="hideFaceRegister()">ë“±ë¡ ì·¨ì†Œ</button>

        <p id="face-save-status" style="margin-top:10px; font-weight: bold;"></p>
      </div>
    </div>

    <script>
      function showFaceRegister() {
        document.getElementById("face-register-ui").style.display = "block";
        document.getElementById("face-cam").src = "/face_stream"; // âœ… ì—¬ê¸°ì„œë§Œ í™œì„±í™”
        document.getElementById("student_id_ajax").value =
        document.querySelector('input[name="student_id"]').value;
      }

      function hideFaceRegister() {
        document.getElementById("face-register-ui").style.display = "none";
        document.getElementById("face-save-status").innerText = "";
        document.getElementById("face-cam").src = ""; // ìº  êº¼ì§
        fetch("/stop_stream", { method: "POST" });
      }

      function saveFace() {
        const studentId = document.getElementById("student_id_ajax").value;

        fetch("/register/face/save/ajax", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ student_id: studentId })
        })
        .then(res => res.json())
        .then(data => {
          const status = document.getElementById("face-save-status");
          if (data.success) {
            status.innerText = "âœ… ì–¼êµ´ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
            hideFaceRegister();

            // ğŸ‘‰ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const registerBtn = document.querySelector("button[onclick='showFaceRegister()']");
            registerBtn.innerText = "âœ… ì–¼êµ´ ë“±ë¡ ì™„ë£Œ";
            registerBtn.disabled = true;
            registerBtn.style.backgroundColor = "#8bc34a";
          } else {
            status.innerText = "ğŸ˜¥ " + (data.error || "ì–¼êµ´ ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        })
        .catch(() => {
          document.getElementById("face-save-status").innerText = "âš ï¸ ìš”ì²­ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        });
      }

    </script>
  </div>
</body>
</html>
